#!/bin/sh

set -euo pipefail
export BCG_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bcg-adduser www


#======================================================================================================================
# Get Nginx Version.
#======================================================================================================================

cd /tmp

VERSION=$(cat VERSION)
bcg-debug "Nginx version ${VERSION}."


#======================================================================================================================
# Install Nginx and dependencies.
#======================================================================================================================

bcg-echo "Installing Nginx v${VERSION}..."
apk add --no-cache \
    ca-certificates \
    nginx=${VERSION}
mkdir -p /var/run/nginx
bcg-done


#======================================================================================================================
# Cleanup.
#======================================================================================================================

CONF_D=/etc/nginx/conf.d
HTTP_D=/etc/nginx/http.d
bcg-debug "Cleaning up default Nginx configuration and files."
rm -rf ${CONF_D}/* ${HTTP_D}/* /var/www/*


#======================================================================================================================
# Create links.
#======================================================================================================================

if [ ! -d ${HTTP_D} ] ; then
    bcg-debug "Linking ${CONF_D} to ${HTTP_D}."
    ln -s ${CONF_D} ${HTTP_D}
fi

bcg-debug "Linking /www to /var/www/localhost."
ln -s /www /var/www/localhost
